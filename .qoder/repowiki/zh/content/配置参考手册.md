# 配置参考手册

<cite>
**本文档引用的文件**
- [options.js](file://options.js)
- [manifest.json](file://manifest.json)
- [background.js](file://background.js)
</cite>

## 目录
1. [AI配置](#ai配置)
2. [平台配置](#平台配置)
3. [导出设置](#导出设置)
4. [权限与配置依赖关系](#权限与配置依赖关系)
5. [配置示例](#配置示例)
6. [常见错误与解决方法](#常见错误与解决方法)

## AI配置

本节详细说明CommentInsight中与AI分析相关的所有可配置选项，这些配置决定了评论分析的质量、速度和成本。

### endpoint（API端点）
- **作用**: 指定AI服务的API基础URL。支持OpenAI官方API以及任何兼容OpenAI API规范的服务（如Azure OpenAI）。
- **合法取值范围**: 有效的HTTPS URL，必须以`https://`开头，并指向一个提供`/chat/completions`和`/models`接口的服务器。
- **默认值**: `https://api.openai.com/v1`
- **注意事项**: 更改此值可以连接到不同的AI提供商，例如将端点改为`https://your-azure-instance.openai.azure.com/openai/deployments/gpt-35-turbo/chat/completions?api-version=2023-05-15`来使用Azure服务。

### apiKey（API密钥）
- **作用**: 用于向AI服务进行身份验证的密钥。没有正确的密钥，AI分析功能将无法工作。
- **合法取值范围**: 由AI服务提供商生成的字符串，通常以`sk-`或特定前缀开头。
- **默认值**: 空字符串 (`''`)
- **安全性提示**: 此密钥应被视为机密信息，切勿分享给他人。在导入/导出配置时，建议清除此字段以保护安全。

### model（模型）
- **作用**: 指定用于分析评论的AI模型名称。不同的模型具有不同的能力、速度和成本。
- **合法取值范围**: 必须是AI服务提供商支持的有效模型ID，例如`gpt-3.5-turbo`, `gpt-4`, `gpt-4-turbo`等。
- **默认值**: `gpt-3.5-turbo`
- **获取方式**: 可通过点击“刷新模型列表”按钮，从当前API端点动态获取可用的模型列表。

### temperature（温度值）
- **作用**: 控制AI输出的随机性和创造性。较低的值使输出更确定和保守，较高的值则更具创造性和多样性。
- **合法取值范围**: 浮点数，介于0.0到2.0之间（包含边界）。
- **默认值**: `0.7`
- **推荐值**:
  - `0.0-0.5`: 适用于需要事实准确性和一致性的场景。
  - `0.6-1.0`: 适用于平衡创造性和准确性的通用分析。
  - `1.1-2.0`: 适用于需要高度创新和多样性的探索性分析。

### maxTokens（最大令牌数）
- **作用**: 限制AI响应的最大长度。这直接影响分析报告的详细程度和API调用的成本。
- **合法取值范围**: 整数，介于100到100,000之间（包含边界）。
- **默认值**: `2000`
- **影响**: 值越大，AI可以生成的文本越长，能够包含更多细节，但也会增加处理时间和成本。

### systemPrompt（系统提示词）
- **作用**: 定义AI在分析评论时的角色和任务指令。它指导AI如何理解输入数据并生成期望格式的输出。
- **合法取值范围**: 任意长度的文本字符串。
- **默认值**: `你是一个专业的社交媒体评论分析师。请分析提供的评论数据，生成包含关键洞察、情感分析、主要主题和趋势的结构化摘要。`
- **自定义建议**: 用户可以根据自己的需求修改此提示词，例如要求AI关注特定的情感维度或生成不同格式的报告。

**Section sources**
- [options.js](file://options.js#L99-L138)
- [options.js](file://options.js#L257-L280)
- [background.js](file://background.js#L445-L468)

## 平台配置

本节涵盖CommentInsight支持的所有社交媒体平台的特定配置选项，确保扩展能正确地从各平台提取评论。

### YouTube配置
- **apiKey (API密钥)**:
  - **作用**: 用于访问YouTube Data API v3的密钥，是提取评论所必需的。
  - **合法取值范围**: Google Cloud Console生成的有效API密钥。
  - **默认值**: 空字符串 (`''`)
- **maxComments (最大评论数)**:
  - **作用**: 限制每次提取操作从单个视频中获取的评论数量。
  - **合法取值范围**: 整数，介于10到1000之间（包含边界）。
  - **默认值**: `100`

### TikTok配置
- **mode (提取模式)**:
  - **作用**: 决定从TikTok提取评论的方式。
  - **合法取值范围**: `'dom'` 或 `'api'`。
    - `'dom'`: 通过解析页面DOM元素来提取评论，这是推荐模式，因为它不依赖官方API。
    - `'api'`: 使用TikTok官方API（如果可用），但可能受到严格的速率限制和认证要求。
  - **默认值**: `'dom'`
- **delay (延迟设置)**:
  - **作用**: 在模拟用户滚动加载更多评论时，两次滚动之间的等待时间（毫秒）。防止因请求过快而被平台反爬虫机制阻止。
  - **合法取值范围**: 整数，介于500到5000毫秒之间（包含边界）。
  - **默认值**: `1000` (1秒)

### Instagram配置
- **token (访问令牌)**:
  - **作用**: 用于访问Instagram Basic Display API的长期访问令牌。
  - **合法取值范围**: Facebook开发者平台生成的有效访问令牌。
  - **默认值**: 空字符串 (`''`)
- **appId (应用ID)**:
  - **作用**: 与访问令牌关联的Facebook应用的唯一标识符。
  - **合法取值范围**: 数字字符串。
  - **默认值**: 空字符串 (`''`)

### Facebook配置
- **appId (应用ID)**:
  - **作用**: 用于访问Facebook Graph API的应用ID。
  - **合法取值范围**: 数字字符串。
  - **默认值**: 空字符串 (`''`)
- **appSecret (应用密钥)**:
  - **作用**: 与应用ID配对使用的密钥，用于增强API调用的安全性。
  - **合法取值范围**: 字符串。
  - **默认值**: 空字符串 (`''`)

### Twitter/X配置
- **bearerToken (Bearer Token)**:
  - **作用**: 用于访问Twitter API v2的OAuth 2.0 Bearer Token，是进行API调用的身份凭证。
  - **合法取值范围**: Twitter开发者账户生成的有效Token。
  - **默认值**: 空字符串 (`''`)
- **apiVersion (API版本)**:
  - **作用**: 指定要使用的Twitter API版本。
  - **合法取值范围**: `'v2'` 或 `'v1.1'`。
  - **默认值**: `'v2'` (推荐)

**Section sources**
- [options.js](file://options.js#L99-L138)
- [options.js](file://options.js#L257-L280)

## 导出设置

本节描述了分析结果的导出选项，允许用户将数据保存为多种格式以便进一步处理或存档。

### csv（CSV格式开关）
- **作用**: 启用或禁用将原始评论数据导出为CSV文件的功能。
- **合法取值范围**: 布尔值 (`true` 或 `false`)。
- **默认值**: `true`
- **文件内容**: 包含作者、内容、时间戳、点赞数和回复数等列的表格数据。

### markdown（Markdown格式开关）
- **作用**: 启用或禁用将AI分析报告导出为Markdown文件的功能。
- **合法取值范围**: 布尔值 (`true` 或 `false`)。
- **默认值**: `true`
- **文件内容**: 结构化的分析报告，包含关键洞察、情感分析、主要主题和趋势，易于阅读和分享。

### json（JSON格式开关）
- **作用**: 启用或禁用将完整数据（包括原始评论和分析结果）导出为JSON文件的功能。
- **合法取值范围**: 布尔值 (`true` 或 `false`)。
- **默认值**: `false`
- **文件内容**: 包含所有数据的机器可读JSON对象，适合程序化处理和长期存储。

### filenamePattern（文件命名规则）
- **作用**: 定义导出文件的文件名模板。支持使用变量来创建有意义且唯一的文件名。
- **合法取值范围**: 包含纯文本和以下变量的字符串：
  - `{platform}`: 当前平台名称（如youtube, tiktok）。
  - `{title}`: 页面标题（已清理特殊字符）。
  - `{date}`: 当前日期（YYYY-MM-DD格式）。
  - `{time}`: 当前时间（HH-MM-SS格式）。
- **默认值**: `{platform}_{title}_{date}`
- **示例**: 如果平台是`youtube`，标题是`我的视频`，日期是`2023-10-27`，则生成的文件名为`youtube_我的视频_2023-10-27.csv`。

**Section sources**
- [options.js](file://options.js#L99-L138)
- [popup.js](file://popup.js#L425-L480)
- [background.js](file://background.js#L577-L616)

## 权限与配置依赖关系

CommentInsight的权限需求与其配置选项紧密相关。`manifest.json`中的权限声明直接支持了各项配置功能的实现。

```mermaid
graph TD
A[Manifest.json权限] --> B[storage]
A --> C[activeTab]
A --> D[scripting]
A --> E[tabs]
A --> F[downloads]
A --> G[host_permissions]
B --> H["chrome.storage.local"]
H --> I["保存和加载配置(config)"]
H --> J["保存评论和分析历史(history)"]
C --> K["获取当前标签页信息"]
K --> L["检测当前平台"]
D --> M["在目标页面注入content.js"]
M --> N["执行DOM解析提取评论"]
E --> O["与后台脚本通信"]
O --> P["发送消息触发提取和分析"]
F --> Q["chrome.downloads.download()"]
Q --> R["导出CSV/Markdown/JSON文件"]
G --> S["https://*.youtube.com/*"]
G --> T["https://*.tiktok.com/*"]
G --> U["https://*.instagram.com/*"]
G --> V["https://*.facebook.com/*"]
G --> W["https://*.twitter.com/*", "https://*.x.com/*"]
```

**Diagram sources**
- [manifest.json](file://manifest.json#L1-L49)
- [background.js](file://background.js#L24-L71)
- [options.js](file://options.js#L99-L138)

**解释**:
- **`storage`权限**: 是所有配置持久化的基础。无论是用户的AI设置、平台API密钥还是导出偏好，都通过`chrome.storage.local` API进行保存和读取。没有此权限，所有配置将在浏览器重启后丢失。
- **`host_permissions`**: 明确授予了扩展访问五大社交媒体平台的权限。这是配置中`endpoint`和平台API密钥生效的前提。没有这些权限，扩展甚至无法加载到目标网站上，导致所有平台相关的配置项（如YouTube的`apiKey`）变得无效。
- **`downloads`权限**: 直接支持了导出功能。当用户启用`csv`、`markdown`或`json`开关并点击导出时，扩展会使用`chrome.downloads.download()` API将数据保存到用户的本地设备。缺少此权限，导出功能将完全失效。
- **`scripting`和`tabs`权限**: 共同实现了跨域通信。`scripting`权限允许在活动标签页中执行`content.js`，而`tabs`权限则允许`background.js`与`content.js`交换消息。这使得配置中的`mode`（如TikTok的`dom`模式）得以实现——后台脚本根据配置发送指令，内容脚本在页面上执行DOM操作。

## 配置示例

以下是两个真实可用的配置示例，展示了如何正确填写配置以连接到不同的AI服务。

### 示例1：标准OpenAI配置
```json
{
  "ai": {
    "endpoint": "https://api.openai.com/v1",
    "apiKey": "sk-your-openai-api-key-here",
    "model": "gpt-4-turbo",
    "temperature": 0.8,
    "maxTokens": 4000,
    "systemPrompt": "你是一个专业的社交媒体评论分析师。请分析提供的评论数据，生成包含关键洞察、情感分析、主要主题和趋势的结构化摘要。"
  }
}
```
**说明**: 这是最常见的配置，连接到OpenAI的官方服务。确保`apiKey`以`sk-`开头，并选择一个可用的模型。

### 示例2：Azure OpenAI配置
```json
{
  "ai": {
    "endpoint": "https://your-resource-name.openai.azure.com/openai/deployments/your-deployment-name",
    "apiKey": "your-azure-api-key-here",
    "model": "gpt-35-turbo",
    "temperature": 0.7,
    "maxTokens": 2000,
    "systemPrompt": "你是一个专业的社交媒体评论分析师。请分析提供的评论数据，生成包含关键洞察、情感分析、主要主题和趋势的结构化摘要。"
  }
}
```
**说明**: 用于连接Azure OpenAI服务。`endpoint`必须包含完整的部署路径，`model`参数在此处通常是固定的（如`gpt-35-turbo`），实际模型由Azure部署决定。

**Section sources**
- [options.js](file://options.js#L99-L138)
- [background.js](file://background.js#L485-L530)

## 常见错误与解决方法

为了避免配置过程中的常见问题，请注意以下几点：

1.  **API连接测试失败**:
    - **原因**: `apiKey`错误、`endpoint`拼写错误或网络问题。
    - **解决**: 使用“测试AI连接”按钮验证配置。检查控制台日志中的具体错误信息。

2.  **无法提取特定平台评论**:
    - **原因**: 未配置该平台所需的API密钥（如YouTube、Instagram）或`host_permissions`缺失。
    - **解决**: 检查`manifest.json`是否包含对应域名，并在配置页面填写正确的凭据。

3.  **导出功能无反应**:
    - **原因**: 缺少`downloads`权限或浏览器阻止了下载。
    - **解决**: 确认扩展已获得所有必要权限，并检查浏览器的下载设置。

4.  **配置导入/导出乱码**:
    - **原因**: 文件编码问题。
    - **解决**: 确保导出的JSON文件使用UTF-8编码。